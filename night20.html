<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DJ RADAR Â· AI NIGHT MODE</title>

<style>
html,body{
  margin:0;
  background:#000;
  overflow:hidden;
  color:#0f0;
  font-family:monospace;
}
#radar{
  width:100vw;
  height:100vh;
  background:radial-gradient(circle,#00ff66 2%,#000 70%);
  animation:spin 4s linear infinite;
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
#hud{
  position:fixed;
  top:14px;
  left:14px;
  z-index:10;
  font-size:18px;
  text-shadow:0 0 10px #0f0;
}
#startScreen{
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99;
}
#startBtn{
  font-size:22px;
  padding:20px 40px;
  border-radius:14px;
  border:none;
  background:#00ffcc;
  color:#000;
}
</style>
</head>

<body>

<div id="radar"></div>

<div id="hud">
  <div id="location">ğŸ“¡ ç­‰å¾…å•Ÿå‹•</div>
  <div id="temp">ğŸŒ¡ --</div>
  <div id="weather">â˜ï¸ --</div>
</div>

<div id="startScreen">
  <button id="startBtn">â–¶ TAP TO START AI NIGHT</button>
</div>

<audio id="music" loop crossorigin="anonymous">
  <source src="https://m-jpg533.github.io/oxs/37.mp4" type="audio/mpeg">
</audio>

<script>
/* ===== DOM ===== */
const music = document.getElementById("music");
const radar = document.getElementById("radar");
const startBtn = document.getElementById("startBtn");
const screen = document.getElementById("startScreen");

const locEl = document.getElementById("location");
const tempEl = document.getElementById("temp");
const weatherEl = document.getElementById("weather");

/* ğŸ”— ä½ çš„ GAS Web App */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzA20FYmlgY6WPMfv2gwlFGk96zluog-6ICqmfar1qiR6OBJ9jLh9lukGpKI82NzsHc/exec";

/* ===== éŸ³æ¨‚ AI ===== */
let audioCtx, analyser, dataArray;

function initAudioAI(){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const source = audioCtx.createMediaElementSource(music);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 512;
  dataArray = new Uint8Array(analyser.frequencyBinCount);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
  analyse();
}

function analyse(){
  analyser.getByteFrequencyData(dataArray);
  const bass = avg(dataArray.slice(0,40));

  const glow = 40 + bass * 1.2;
  radar.style.boxShadow = `0 0 ${glow}px #00ffcc`;

  requestAnimationFrame(analyse);
}

function avg(arr){
  return arr.reduce((a,b)=>a+b,0)/arr.length;
}

/* ===== æ°£è±¡ AI ===== */
let weatherList=[], index=0;

function loadAllWeather(){
  fetch(GAS_URL)
    .then(r=>r.json())
    .then(data=>{
      weatherList=data;
      showWeather();
      setInterval(showWeather,10000);
    })
    .catch(()=>{
      locEl.innerText="âŒ æ°£è±¡è®€å–å¤±æ•—";
    });
}

function showWeather(){
  if(!weatherList.length) return;

  const w=weatherList[index];
  locEl.innerText="ğŸ“ "+w.location;
  tempEl.innerText=`ğŸŒ¡ ${w.minT} ~ ${w.maxT} Â°C`;
  weatherEl.innerText="â˜ï¸ "+w.weather;

  /* å¤©æ°£ â†’ é›·é” AI */
  if(w.weather.includes("é›¨")){
    radar.style.background="radial-gradient(circle,#00ccff,#000)";
    radar.style.animationDuration="8s";
  }else if(Number(w.minT)<10){
    radar.style.background="radial-gradient(circle,#cc66ff,#000)";
    radar.style.animationDuration="10s";
  }else{
    radar.style.background="radial-gradient(circle,#00ff66,#000)";
    radar.style.animationDuration="4s";
  }

  index=(index+1)%weatherList.length;
}

/* ===== å•Ÿå‹• ===== */
startBtn.onclick = async ()=>{
  await music.play();           // ğŸ“± æ‰‹æ©Ÿå¿…æœ‰è²
  initAudioAI();                // ğŸ§ éŸ³æ¨‚ AI
  loadAllWeather();             // ğŸŒ¦ å…¨å°æ°£è±¡
  screen.style.display="none";
};
</script>

</body>
</html>
