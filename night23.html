<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨å°å³æ™‚æ¸¬ç«™é›·é”åŒ– Â· ç©ºé–“å®šä½ç‰ˆ</title>

<style>
html,body{
  margin:0;
  background:#000;
  overflow:hidden;
}
canvas{display:block}
#hud{
  position:fixed;
  left:10px;
  bottom:10px;
  color:#0f0;
  font-family:monospace;
  font-size:12px;
  opacity:.8;
}
</style>
</head>

<body>
<canvas id="cv"></canvas>
<div id="hud">TAIWAN LIVE DATA RADAR Â· LABEL FIX</div>

<script>
/* =========================
   Canvas
========================= */
const isMobile = Math.min(innerWidth, innerHeight) < 600;

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");

function resize(){
  cv.width = innerWidth;
  cv.height = innerHeight;
}
addEventListener("resize",resize);
resize();


/* =========================
   å°ç£æ¸¬ç«™
========================= */
let stations = [
 {name:"è‡ºåŒ—",lat:25.04,lon:121.56},
 {name:"æ–°åŒ—",lat:25.01,lon:121.46},
 {name:"æ¡ƒåœ’",lat:24.99,lon:121.31},
 {name:"æ–°ç«¹",lat:24.81,lon:120.97},
 {name:"è‡ºä¸­",lat:24.15,lon:120.67},
 {name:"å˜‰ç¾©",lat:23.48,lon:120.44},
 {name:"è‡ºå—",lat:22.99,lon:120.21},
 {name:"é«˜é›„",lat:22.63,lon:120.30},
 {name:"å±æ±",lat:22.67,lon:120.49},
 {name:"å®œè˜­",lat:24.76,lon:121.75},
 {name:"èŠ±è“®",lat:23.97,lon:121.60},
 {name:"è‡ºæ±",lat:22.75,lon:121.15}
];

stations.forEach(s => s.temp = NaN);

/* =========================
   åŒ—éƒ¨æ–‡å­—åç§»è¨­å®š
========================= */
const labelOffset = isMobile
? {
    // ğŸ“± æ‰‹æ©Ÿï¼ˆå¤§å¹…æ‹‰é–‹ï¼‰
    "è‡ºåŒ—": { x: 28,  y: -42 },
    "æ–°åŒ—": { x: -70, y: 34 },
    "æ¡ƒåœ’": { x: -62, y: -40 }
  }
: {
    // ğŸ–¥ æ¡Œæ©Ÿ
    "è‡ºåŒ—": { x: 14,  y: -18 },
    "æ–°åŒ—": { x: -38, y: 12 },
    "æ¡ƒåœ’": { x: -30, y: -18 }
  };


/* =========================
   ç¶“ç·¯åº¦ â†’ ç•«é¢
========================= */
const latR={min:21.7,max:25.5};
const lonR={min:119.5,max:122.3};

const mapX = lon => (lon-lonR.min)/(lonR.max-lonR.min)*cv.width;
const mapY = lat => cv.height-(lat-latR.min)/(latR.max-latR.min)*cv.height;

/* =========================
   ä½¿ç”¨è€…å®šä½ = é›·é”ä¸­å¿ƒ
========================= */
let user = {lat:23.8,lon:121};
navigator.geolocation?.getCurrentPosition(p=>{
  user.lat=p.coords.latitude;
  user.lon=p.coords.longitude;
});

/* =========================
   ä¸­å¤®æ°£è±¡ç½² API
========================= */
const API_KEY = "CWA-6DEFC9E1-5016-483E-9751-F71428FEE7D3";
const API_URL =
`https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=${API_KEY}&format=JSON`;

async function loadWeather(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    const list = data.records.Station;

    stations.forEach(s=>{
      const st = list.find(r => r.StationName.includes(s.name));
      if(st){
        const t = parseFloat(st.WeatherElement.AirTemperature);
        if(!isNaN(t)) s.temp = t;
      }
    });
  }catch(e){
    console.warn("æ°£è±¡ API è®€å–å¤±æ•—");
  }
}
loadWeather();
setInterval(loadWeather,60000);

/* =========================
   Animation
========================= */
let t=0;
function draw(){
  ctx.fillStyle="rgba(0,0,0,.25)";
  ctx.fillRect(0,0,cv.width,cv.height);

  // é›·é”ä¸­å¿ƒ
  const ux = mapX(user.lon);
  const uy = mapY(user.lat);

  ctx.strokeStyle="rgba(0,255,0,.3)";
  ctx.beginPath();
  ctx.arc(ux,uy,60+Math.sin(t)*10,0,Math.PI*2);
  ctx.stroke();

  ctx.strokeStyle="rgba(0,255,0,.15)";
  ctx.beginPath();
  ctx.arc(ux,uy,Math.max(cv.width,cv.height),t,t+.4);
  ctx.stroke();

  // æ¸¬ç«™
  stations.forEach(s=>{
    const x = mapX(s.lon);
    const y = mapY(s.lat);
    const pulse = 6 + Math.sin(t*2 + s.lat)*3;

    const temp = s.temp;
    const hue = isNaN(temp) ? 120 : 120 - (temp - 20) * 5;

    // é›·é”æ³¢
    ctx.strokeStyle = `hsla(${hue},100%,50%,.25)`;
    ctx.beginPath();
    ctx.arc(x,y,pulse,0,Math.PI*2);
    ctx.stroke();

    // æ ¸å¿ƒé»
    ctx.fillStyle = `hsl(${hue},100%,60%)`;
    ctx.beginPath();
    ctx.arc(x,y,2.5,0,Math.PI*2);
    ctx.fill();

    // åœ°é»æ–‡å­—ï¼ˆå«é¿è®“ï¼‰
    const off = labelOffset[s.name] || {x:8,y:8};
    ctx.fillStyle="#0f0";
    ctx.font="12px monospace";
    ctx.textAlign="left";
    ctx.textBaseline="middle";
    ctx.fillText(s.name, x + off.x, y + off.y);

    // æº«åº¦æ–‡å­—
    if(!isNaN(temp)){
      ctx.font="11px monospace";
      ctx.fillText(`${temp.toFixed(1)}Â°C`, x + off.x, y + off.y - 14);
    }
  });

  t+=0.01;
  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
