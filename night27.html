<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å°ç£å³æ™‚æ°£è±¡æˆ°æƒ…é›·é”ç³»çµ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body,#map{
  margin:0;
  width:100%;
  height:100%;
  background:#000;
}
.station-label{
  color:#0ff;
  font-size:12px;
  text-shadow:0 0 4px #0ff;
  white-space:nowrap;
}
.alert-hot{
  color:#f00;
  animation:blink 1s infinite;
}
@keyframes blink{
  50%{opacity:.3}
}
</style>
</head>

<body>
<div id="map"></div>

<script>
/* =========================
   1ï¸âƒ£ åœ°åœ–åˆå§‹åŒ–ï¼ˆçœŸå¯¦å°ç£ï¼‰
========================= */
const map = L.map('map',{
  center:[23.7,121],
  zoom:7,
  zoomControl:false
});

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
).addTo(map);

/* =========================
   2ï¸âƒ£ åŸå¸‚ï¼ˆé¡¯ç¤ºç”¨ï¼Œä¸ç›´æ¥ç¶æ¸¬ç«™ï¼‰
========================= */
const cities = [
  {name:"å°åŒ—",lat:25.0375,lng:121.5637},
  {name:"æ–°åŒ—",lat:25.012,lng:121.465},
  {name:"æ¡ƒåœ’",lat:24.993,lng:121.301},
  {name:"å°ä¸­",lat:24.1477,lng:120.6736},
  {name:"å˜‰ç¾©",lat:23.4801,lng:120.4491},
  {name:"å°å—",lat:22.9999,lng:120.2269},
  {name:"é«˜é›„",lat:22.6273,lng:120.3014},
  {name:"å±æ±",lat:22.5519,lng:120.5487},
  {name:"å°æ±",lat:22.7583,lng:121.1444},
  {name:"èŠ±è“®",lat:23.9872,lng:121.6015}
];

/* =========================
   3ï¸âƒ£ ä¸­å¤®æ°£è±¡ç½² API
========================= */
const API_KEY = "CWA-6DEFC9E1-5016-483E-9751-F71428FEE7D3";
const API_URL =
`https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=${API_KEY}&format=JSON`;

let stationsData = [];

/* è¨ˆç®—è·é›¢ï¼ˆæ‰¾æœ€è¿‘æ¸¬ç«™ï¼‰ */
function distance(a,b,c,d){
  return Math.hypot(a-c,b-d);
}

/* =========================
   4ï¸âƒ£ å»ºç«‹åŸå¸‚é›·é”
========================= */
cities.forEach(c=>{
  c.label = L.marker([c.lat,c.lng],{
    icon:L.divIcon({
      className:'station-label',
      html:`${c.name} --Â°C`,
      iconAnchor:[-10,-10]
    })
  }).addTo(map);

  c.radar = L.circle([c.lat,c.lng],{
    radius:18000,
    color:'#0ff',
    opacity:0.6,
    fillOpacity:0
  }).addTo(map);

  /* é›·é”å‹•ç•« */
  let grow=true;
  setInterval(()=>{
    let r=c.radar.getRadius();
    c.radar.setRadius(grow ? r+800 : r-800);
    if(r>35000) grow=false;
    if(r<16000) grow=true;
  },120);

  /* é»æ“Šå½ˆå‡ºæ°£è±¡å¡ç‰‡ */
  c.radar.bindPopup("è¼‰å…¥ä¸­...");
});

/* =========================
   5ï¸âƒ£ æ›´æ–°å³æ™‚æº«åº¦ï¼ˆæœ€è¿‘æ¸¬ç«™ï¼‰
========================= */
async function updateWeather(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    stationsData = data.records.Station;

    cities.forEach(c=>{
      let nearest=null, min=999;
      stationsData.forEach(s=>{
        const d = distance(c.lat,c.lng,s.GeoInfo.Coordinates[1].StationLatitude,
                           s.GeoInfo.Coordinates[1].StationLongitude);
        if(d<min){ min=d; nearest=s; }
      });

      if(nearest){
        const t = parseFloat(nearest.WeatherElement.AirTemperature);
        const h = parseFloat(nearest.WeatherElement.RelativeHumidity);
        const w = parseFloat(nearest.WeatherElement.WindSpeed);

        let cls = t>=36 ? "station-label alert-hot":"station-label";

        c.label.setIcon(L.divIcon({
          className:cls,
          html:`${c.name} ${t.toFixed(1)}Â°C`,
          iconAnchor:[-10,-10]
        }));

        c.radar.setPopupContent(`
          <b>${c.name}</b><br>
          ğŸŒ¡ ${t.toFixed(1)}Â°C<br>
          ğŸ’§ ${h}%<br>
          ğŸŒ¬ ${w} m/s<br>
          ğŸ•’ ${nearest.ObsTime.DateTime}
        `);
      }
    });

  }catch(e){
    console.warn("æ°£è±¡æ›´æ–°å¤±æ•—",e);
  }
}

updateWeather();
setInterval(updateWeather,10*60*1000);

/* =========================
   6ï¸âƒ£ ä½¿ç”¨è€…å®šä½
========================= */
navigator.geolocation?.getCurrentPosition(p=>{
  L.circleMarker(
    [p.coords.latitude,p.coords.longitude],
    {radius:6,color:'#ff0'}
  ).addTo(map).bindPopup("ä½ åœ¨é€™è£¡");
});

/* =========================
   7ï¸âƒ£ çœŸå¯¦æ°£è±¡é›·é”ï¼ˆé™é›¨ï¼‰
========================= */
L.tileLayer.wms(
  "https://opengeo.cwa.gov.tw/geoserver/cwa/wms",
  {
    layers:"cwa:CV1_3600",
    format:"image/png",
    transparent:true,
    opacity:0.55
  }
).addTo(map);
</script>

</body>
</html>
